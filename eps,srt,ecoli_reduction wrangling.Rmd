---
title: "EPS and SRT Wrangling"
author: "Kate Pogue"
date: "2023-06-16"
output: html_document
---


Loading Packages
```{r}
library(tidyverse)
library(Metrics)
library(tidyr)
library(dplyr)
library(olsrr)
library(openxlsx)
library(readxl)
library(lubridate)
```

Loading Data
```{r}
getwd()
NAB2 <- read_csv("data/NAB2.csv")
EPS <- read_excel("data/all_EPS.xlsx")
ASRT_main <- read_excel("data/ASRT_main.xlsx")
ASRT_other <- read_excel("data/ASRT_other.xlsx")
```

make e. coli reduction variable 
```{r}
#select relevant variables
ecoli <- NAB2 %>% select(timestamp, 
                         "NAB2 Clarifier Effluent E. coli (LAB) (EC/100mL)", 
                         "NAB4 Clarifier Effluent E. coli (LAB) (EC/100mL)", 
                         "NSI E. coli (LAB) (EC/100mL)", 
                         "NAB9 Clarifier Effluent E. coli (LAB) (EC/100mL)")

#merge the basin 4 and 9 data
ecoli$`NAB4 Clarifier Effluent E. coli (LAB) (EC/100mL)`[is.na(ecoli$`NAB4 Clarifier Effluent E. coli (LAB) (EC/100mL)`)] <- 0
ecoli$`NAB9 Clarifier Effluent E. coli (LAB) (EC/100mL)`[is.na(ecoli$`NAB9 Clarifier Effluent E. coli (LAB) (EC/100mL)`)] <- 0

ecoli <- mutate(ecoli, "NAB4 and 9 Clarifier Effluent E. coli (LAB) (EC/100mL)" = 
              (ecoli$`NAB4 Clarifier Effluent E. coli (LAB) (EC/100mL)` + ecoli$'NAB9 Clarifier Effluent E. coli (LAB) (EC/100mL)'))

ecoli$'NAB4 and 9 Clarifier Effluent E. coli (LAB) (EC/100mL)'[ecoli$'NAB4 and 9 Clarifier Effluent E. coli (LAB) (EC/100mL)' == 0] <- NA
ecoli <- ecoli %>% select(-'NAB4 Clarifier Effluent E. coli (LAB) (EC/100mL)', -'NAB9 Clarifier Effluent E. coli (LAB) (EC/100mL)')

## make LOG reduction variable
ecoli$log_pilot_reduction <- log(ecoli$`NSI E. coli (LAB) (EC/100mL)`)- log(ecoli$`NAB2 Clarifier Effluent E. coli (LAB) (EC/100mL)`)

ecoli$log_control_reduction <- log(ecoli$`NSI E. coli (LAB) (EC/100mL)`)-log(ecoli$`NAB4 and 9 Clarifier Effluent E. coli (LAB) (EC/100mL)`)


## normal effluent variables just need to be log transformed
ecoli$log_pilot_ecoli <- log(ecoli$`NAB2 Clarifier Effluent E. coli (LAB) (EC/100mL)`)
ecoli$log_control_ecoli <- log(ecoli$`NAB4 and 9 Clarifier Effluent E. coli (LAB) (EC/100mL)`)


#only select useful variables
ecoli <- ecoli %>% select(timestamp, 
                          log_pilot_reduction, 
                          log_control_reduction, 
                          log_pilot_ecoli, 
                          log_control_ecoli)
ecoli <- na.omit(ecoli)

#look at distributions
ggplot() +
  geom_density(data = ecoli, aes(x = log_pilot_ecoli), color = "red", fill = "red", alpha = 0.3) +
  geom_density(data = ecoli, aes(x = log_control_ecoli), color = "blue", fill = "blue", alpha = 0.3) +
  geom_density(data = ecoli, aes(x = log_pilot_reduction), color = "green", fill = "green", alpha = 0.3) +
  geom_density(data = ecoli, aes(x = log_control_reduction), color = "orange", fill = "orange", alpha = 0.3) +
  xlab("Value") +
  ylab("Density") +
  ggtitle("Densities of Ecoli Variables") +
  theme_minimal()


# Plot Reductions as line graphs
ggplot(ecoli, aes(x = timestamp)) +
  geom_line(aes(y = log_pilot_reduction, color = "Pilot")) +
  geom_line(aes(y = log_control_reduction, color = "Control")) +
  labs(x = "Timestamp", y = "E. coli reduction (EC/100mL)",
       title = "E. coli Reduction Timeseries") +
  scale_color_manual(values = c("blue", "red")) +
  theme_minimal()
```



PILOT: Wrangle EPS 
```{r}
#rename timestamp
EPS <- EPS %>% rename(timestamp = 1)

#select pilot variables
pilot_eps <- EPS %>% select(timestamp, starts_with("Pilot"))

#get other factors
others <- NAB2 %>% select(timestamp,
                          "AB2A DO (mg/L)",  
                          "AB2A NO5 (mgN/L)",  
                          "AB2A NH3 (mg N/L)", 
                          "AB2C NH3 (mg N/L)", 
                          "NSI TEMP (C)",
                          "Clarifier 2 SLR (ppd/sf)",
                          "NSI TKNH (LAB) (mg/L)",
                          "AB2 Anaerobic F/M  (g sCOD/ g MLSS)",
                          "AB2A AIRFLOW (SCFM)"
                          
                          )
colnames(others) <- c("timestamp",
                          "AB2A_DO_mg_per_L",  
                          "AB2A_NO5_mgN_per_L",  
                          "AB2A_NH3_mg_N_per_L", 
                          "AB2C_NH3_mg_N_per_L", 
                          "NSI_TEMP_C",
                          "Clarifier_2_SLR_ppd_sf",
                          "NSI_TKNH_LAB_mg_per_L",
                          "AB2_Anaerobic_FM_g_sCOD_g_MLSS",
                          "AB2_INF_FLOW_MGD",
                          "AB2A_AIRFLOW_SCFM"
                          )

#get other ASRT variables for pilot
ASRT_other_pilot <- ASRT_other %>% select(timestamp, starts_with("Pilot"))
colnames(ASRT_other_pilot) <- c("timestamp",
                                "Pilot_ASRT_d",
                                "Pilot_Floc_SRT_d",
                                "Pilot_Granule_SRT_d",
                                "Pilot_AGS_Weighted_SRT_d",
                                "Pilot_Floc_percent",
                                "Pilot_Granule_percent")

#select pilot ecoli
pilot_ecoli <- ecoli %>% select(timestamp, "log_pilot_reduction", "log_pilot_ecoli")
pilot_factors <- left_join(pilot_ecoli, pilot_eps, by = "timestamp")
colnames(pilot_factors) <- c("timestamp", "log_pilot_reduction", "log_pilot_ecoli", "pilot_total_cod_mgcod_per_gvss",
                  "pilot_total_pn_to_ps", "pilot_lb_cod_mgcod_per_gvss",
                  "pilot_lb_proteins_mg_per_gvss", "pilot_lb_carbs_mg_per_gvss",
                  "pilot_tb_cod_mgcod_per_gvss", "pilot_tb_proteins_mg_per_gvss",
                  "pilot_tb_carbs_mgcarb_per_gvss", "pilot_tb_pn_to_ps")


#FILL method to fill in missing EPS and ASRT values
pilot_eps_filled <- left_join(pilot_factors, others, by = "timestamp")
pilot_eps_filled <- left_join(pilot_eps_filled, ASRT_main[,-3], by = "timestamp")
pilot_eps_filled <- left_join(pilot_eps_filled, ASRT_other_pilot, by = "timestamp")
pilot_eps_filled <- pilot_eps_filled %>% fill(-c("Pilot_NAB2_ASRT",
                  "AB2_Anaerobic_FM_g_sCOD_g_MLSS","pilot_total_cod_mgcod_per_gvss",
                  "pilot_total_pn_to_ps", "pilot_lb_cod_mgcod_per_gvss",
                  "pilot_lb_proteins_mg_per_gvss", "pilot_lb_carbs_mg_per_gvss",
                  "pilot_tb_cod_mgcod_per_gvss", "pilot_tb_proteins_mg_per_gvss",
                  "pilot_tb_carbs_mgcarb_per_gvss", "pilot_tb_pn_to_ps")
                                              , .direction = "down")
pilot_eps_filled <- pilot_eps_filled[-c(1:7),]
pilot_eps_filled <- pilot_eps_filled %>% fill(everything(), .direction = "down")

#REMOVE method
pilot_eps_removed <- left_join(pilot_factors, others, by = "timestamp")
pilot_eps_removed <- left_join(pilot_eps_removed, ASRT_main[,-3], by = "timestamp")
pilot_eps_removed <- left_join(pilot_eps_removed, ASRT_other_pilot, by = "timestamp")
pilot_eps_removed <- na.omit(pilot_eps_removed)


```


Control: Wrangle EPS 
```{r}
#rename timestamp
EPS <- EPS %>% rename(timestamp = 1)

#select control variables
control_eps <- EPS %>% select(timestamp, starts_with("Control"))


#get other factors
others <- NAB2 %>% select(timestamp,
                          "AB9A DO (mg/L)",  
                          "AB9A NO5 (mg N/L)",  
                          "AB9A NH3 (mg N/L)", 
                          "AB9C NH3 (mg N/L)", 
                          "NSI TEMP (C)",
                          "Clarifier 9 SLR (ppd/sf)",
                          "AB9 INF FLOW (MGD)",
                          "AB9A AIRFLOW (SCFM)"
                          
                          )
colnames(others) <- c("timestamp",
                          "AB9A_DO_mg_per_L",  
                          "AB9A_NO5_mgN_per_L",  
                          "AB9A_NH3_mg_N_per_L", 
                          "AB9C_NH3_mg_N_per_L", 
                          "NSI_TEMP_C",
                          "Clarifier_9_SLR_ppd_sf",
                          "AB9_INF_FLOW_MGD",
                          "AB9A_AIRFLOW_SCFM"
                          )

#get other ASRT variables for pilot
ASRT_other_control <- ASRT_other %>% select(timestamp, starts_with("Control"))
colnames(ASRT_other_control) <- c("timestamp",
                                "Control_ASRT_d",
                                "Control_Floc_SRT_d",
                                "Control_Granule_SRT_d",
                                "Control_AGS_Weighted_SRT_d",
                                "Control_Floc_percent",
                                "Control_Granule_percent")

#select Control ecoli
control_ecoli <- ecoli %>% select(timestamp, log_control_reduction, log_control_ecoli)
control_factors <- left_join(control_ecoli, control_eps, by = "timestamp")
colnames(control_factors) <- c("timestamp", "log_control_reduction", 
                  "log_control_ecoli", "control_total_cod_mgcod_per_gvss",
                  "control_total_pn_to_ps", "control_lb_cod_mgcod_per_gvss",
                  "control_lb_proteins_mg_per_gvss", "control_lb_carbs_mg_per_gvss",
                  "control_tb_cod_mgcod_per_gvss", "control_tb_proteins_mg_per_gvss",
                  "control_tb_carbs_mgcarb_per_gvss", "control_tb_pn_to_ps")


#FILL method to fill in missing EPS and ASRT values
control_eps_filled <- left_join(control_factors, others, by = "timestamp")
control_eps_filled <- left_join(control_eps_filled, ASRT_main[,-2], by = "timestamp")
control_eps_filled <- left_join(control_eps_filled, ASRT_other_control, by = "timestamp")
control_eps_filled <- control_eps_filled %>% fill(-c("Control_NSEC_ASRT",
                                                     "control_total_cod_mgcod_per_gvss",
                  "control_total_pn_to_ps", "control_lb_cod_mgcod_per_gvss",
                  "control_lb_proteins_mg_per_gvss", "control_lb_carbs_mg_per_gvss",
                  "control_tb_cod_mgcod_per_gvss", "control_tb_proteins_mg_per_gvss",
                  "control_tb_carbs_mgcarb_per_gvss", "control_tb_pn_to_ps"
                                                     ), .direction = "down")
control_eps_filled <- control_eps_filled[-c(1:7),]
control_eps_filled <- control_eps_filled %>% fill(everything(), .direction = "down")

#REMOVE method
control_eps_removed <- left_join(control_factors, others, by = "timestamp")
control_eps_removed <- left_join(control_eps_removed, ASRT_main[,-2], by = "timestamp")
control_eps_removed <- left_join(control_eps_removed, ASRT_other_control, by = "timestamp")
control_eps_removed <- na.omit(control_eps_removed)

```

Combine Control and Pilot FIIL data with each system being a factorial variable
```{r}
#Combine for FILL data

#remove column that the two sets don't have in common
pilot_eps_filled <- pilot_eps_filled[, -which(names(pilot_eps_filled) == "NSI_TKNH_LAB_mg_per_L")]

# Mutate 'system' variable to be a factor with all 2s for pilot and all 9s for control
pilot_eps_filled <- pilot_eps_filled %>%
  mutate(system = factor(rep(2, nrow(pilot_eps_filled))))

control_eps_filled <- control_eps_filled %>%
  mutate(system = factor(rep(9, nrow(control_eps_filled))))


#change both dataframe names to match

new_column_names <- c("timestamp", 
                      "log_ecoli_reduction",
                      "log_ecoli",
                      "total_cod_mgcod_per_gvss",
                      "total_pn_to_ps",
                      "lb_cod_mgcod_per_gvss",
                      "lb_proteins_mg_per_gvss",
                      "lb_carbs_mg_per_gvss",   
                      "tb_cod_mgcod_per_gvss",
                      "tb_proteins_mg_per_gvss",
                      "tb_carbs_mgcarb_per_gvss", 
                      "tb_pn_to_ps",
                      "ABXA_DO_mg_per_L",
                      "ABXA_NO5_mgN_per_L",              
                      "ABXA_NH3_mg_N_per_L",
                      "ABXC_NH3_mg_N_per_L",             
                      "NSI_TEMP_C", 
                      "Clarifier_X_SLR_ppd_sf",          
                      "ABX_INF_FLOW_MGD",                 
                      "ABXA_AIRFLOW_SCFM",               
                      "NSEC_ASRT",               
                      "ASRT_d",                  
                      "floc_SRT_d",               
                      "granule_SRT_d",           
                      "AGS_weighted_SRT_d",       
                      "floc_percent",            
                      "granule_percent",          
                      "system"              
                      )  # New column names

pilot_eps_filled <- setNames(pilot_eps_filled, new_column_names)
control_eps_filled <- setNames(control_eps_filled, new_column_names)

# Stack the dataframes vertically and change column names
all_eps_filled <- rbind(pilot_eps_filled, control_eps_filled)


## add day of the year variable and day of the week variable
all_eps_filled <- all_eps_filled %>%
  mutate(
    day_of_week = wday(timestamp, label = TRUE),
    day_of_week = factor(day_of_week, levels = c("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat")),
    month = month(timestamp, label = TRUE),
    month = factor(month, levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))
  )
```


Combine Control and Pilot REMOVE data with each system being a factorial variable
```{r}
#remove column that the two sets don't have in common
pilot_eps_removed <- pilot_eps_removed[, -which(names(pilot_eps_removed) == "NSI_TKNH_LAB_mg_per_L")]

# Mutate 'system' variable to be a factor with all 2s for pilot and all 9s for control
pilot_eps_removed <- pilot_eps_removed %>%
  mutate(system = factor(rep(2, nrow(pilot_eps_removed))))

control_eps_removed <- control_eps_removed %>%
  mutate(system = factor(rep(9, nrow(control_eps_removed))))


#change both dataframe names to match

new_column_names <- c("timestamp", 
                      "log_ecoli_reduction",
                      "log_ecoli",
                      "total_cod_mgcod_per_gvss",
                      "total_pn_to_ps",
                      "lb_cod_mgcod_per_gvss",
                      "lb_proteins_mg_per_gvss",
                      "lb_carbs_mg_per_gvss",   
                      "tb_cod_mgcod_per_gvss",
                      "tb_proteins_mg_per_gvss",
                      "tb_carbs_mgcarb_per_gvss", 
                      "tb_pn_to_ps",
                      "ABXA_DO_mg_per_L",
                      "ABXA_NO5_mgN_per_L",              
                      "ABXA_NH3_mg_N_per_L",
                      "ABXC_NH3_mg_N_per_L",             
                      "NSI_TEMP_C", 
                      "Clarifier_X_SLR_ppd_sf",          
                      "ABX_INF_FLOW_MGD",                 
                      "ABXA_AIRFLOW_SCFM",               
                      "NSEC_ASRT",               
                      "ASRT_d",                  
                      "floc_SRT_d",               
                      "granule_SRT_d",           
                      "AGS_weighted_SRT_d",       
                      "floc_percent",            
                      "granule_percent",          
                      "system"              
                      )  # New column names

pilot_eps_removed <- setNames(pilot_eps_removed, new_column_names)
control_eps_removed <- setNames(control_eps_removed, new_column_names)

# Stack the dataframes vertically and change column names
all_eps_removed <- rbind(pilot_eps_removed, control_eps_removed)


## add day of the year variable and day of the week variable
all_eps_removed <- all_eps_removed %>%
  mutate(
    day_of_week = wday(timestamp, label = TRUE),
    day_of_week = factor(day_of_week, levels = c("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat")),
    month = month(timestamp, label = TRUE),
    month = factor(month, levels = c("Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"))
  )
```


Export new dataframes as csv files
```{r}
# Write all FILLED
write.csv(all_eps_filled, file = "/Users/katepogue/Desktop/git_mowater/data/all_eps_filled.csv", row.names = FALSE)

# Write all REMOVE
write.csv(all_eps_removed, file = "/Users/katepogue/Desktop/git_mowater/data/all_eps_removed.csv", row.names = FALSE)

```

