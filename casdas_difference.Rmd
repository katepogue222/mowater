---
title: "Week 2 CAS vs DAS"
author: "Kate Pogue"
date: "2023-06-13"
output: pdf_document
---


Loading packages
```{r}
library(tidyverse)
library(boot)
```


Loating Data
```{r}
NAB2 <- read_csv("data/NAB2.csv")
```


Subset data
```{r}
cols_in_use <- c("Clarifier 2 SLR (ppd/sf)", 
  "Clarifier 9 SLR (ppd/sf)",
  "Clarifier 2 SOR (gpd/sf)", 
  "Clarifier 9 SOR (gpd/sf)",
  "NAB2 Clarifier Effluent E. coli (LAB) (EC/100mL)",
  "NAB4 Clarifier Effluent E. coli (LAB) (EC/100mL)",
  "NAB9 Clarifier Effluent E. coli (LAB) (EC/100mL)",
  "NAB2 C-Pass Total COD (LAB) (mg/L)", 
  "NAB9 C-Pass Total COD (LAB) (mg/L)",
  "NAB2 C-Pass TKNH (LAB) (mg/L)", 
  "NAB4 C-Pass TKNH (LAB) (mg/L)",
  "NAB9 C-Pass TKNH (LAB) (mg/L)",
  "NAB2 C-Pass TSS (LAB) (mg/L)",
  "NAB9 C-Pass TSS (LAB) (mg/L)",
  "NAB2 C-Pass VSS (LAB) (mg/L)", 
  "NAB9 C-Pass VSS (LAB) (mg/L)",
  "AB2A DO (mg/L)", "AB9A DO (mg/L)",
  "AB2B DO (mg/L)", "AB9B DO (mg/L)",
  "AB2C DO (mg/L)", "AB9C DO (mg/L)",
  "AB2A NO5 (mgN/L)", "AB9A NO5 (mg N/L)",
  "AB2A NH3 (mg N/L)", "AB9A NH3 (mg N/L)",
  "AB2C NH3 (mg N/L)", "AB9C NH3 (mg N/L)",
  "AB2C MLSS (mg/L)", "AB9C MLSS (mg/L)",
  "SAR 2 PH (Std Units)", "SAR 4 PH (Std Units)",
  "SAR 2 ORP (mV)", "SAR 4 ORP (mV)",
  "SAR 2 MLSS (mg/L)", "SAR 4 MLSS (mg/L)",
  "AB2 INF FLOW (MGD)", "AB9 INF FLOW (MGD)",
  "AB2 MLR FLOW (MGD)", "AB9 MLR FLOW (MGD)",
  "AB2A AIRFLOW (SCFM)", "AB9A AIRFLOW (SCFM)",
  "AB2B AIRFLOW (SCFM)", "AB9B AIRFLOW (SCFM)",
  "AB2C AIRFLOW (SCFM)", "AB9C AIRFLOW (SCFM)",
  "SAR2 RAS FLOW B (MGD)", "SAR4 RAS FLOW B (MGD)",
  "SAR2 GTE FLOW (gpm)", "SAR4 GTE FLOW (gpm)",
  "SC2 BLANKET (ft)", "SC9 BLANKET (ft)",
  "NAB2 C-Pass dSVI 30 (mL/g)", "NAB4 C-Pass dSVI 30 (mL/g)", "NAB9 C-Pass dSVI 30 (mL/g)",
  "NAB2 C-Pass dSVI 5 (mL/g)", "NAB4 C-Pass dSVI 5 (mL/g)", "NAB9 C-Pass dSVI 5 (mL/g)")
  
casdas <- NAB2[,cols_in_use]

#Look for zeros in each variable

# Initialize a vector to store the counts
zero_counts <- numeric(length = ncol(casdas))

# Loop through each variable
for (i in 1:ncol(casdas)) {
  # Count the number of 0 values for the current variable
  zero_counts[i] <- sum(casdas[, i] == 0)
}

zero_df <- cbind(cols_in_use, zero_counts)

#turn zeroing out to NA values

casdas$'AB9A NO5 (mg N/L)'[casdas$'AB9A NO5 (mg N/L)' == 0] <- NA
casdas$'AB9A NH3 (mg N/L)'[casdas$'AB9A NH3 (mg N/L)' == 0] <- NA
casdas$'AB9C MLSS (mg/L)'[casdas$'AB9C MLSS (mg/L)' == 0] <- NA
casdas$'AB2 INF FLOW (MGD)'[casdas$'AB2 INF FLOW (MGD)' == 0] <- NA
casdas$'AB9 INF FLOW (MGD)'[casdas$'AB9 INF FLOW (MGD)' == 0] <- NA
casdas$'AB9 MLR FLOW (MGD)'[casdas$'AB9 MLR FLOW (MGD)' == 0] <- NA
casdas$'SAR2 GTE FLOW (gpm)'[casdas$'SAR2 GTE FLOW (gpm)' == 0] <- NA
casdas$'SAR4 GTE FLOW (gpm)'[casdas$'SAR4 GTE FLOW (gpm)' == 0] <- NA


##combining some columns

casdas$`NAB4 Clarifier Effluent E. coli (LAB) (EC/100mL)`[is.na(casdas$`NAB4 Clarifier Effluent E. coli (LAB) (EC/100mL)`)] <- 0
casdas$`NAB9 Clarifier Effluent E. coli (LAB) (EC/100mL)`[is.na(casdas$`NAB9 Clarifier Effluent E. coli (LAB) (EC/100mL)`)] <- 0

casdas <- mutate(casdas, "NAB4 and 9 Clarifier Effluent E. coli (LAB) (EC/100mL)" = 
              (casdas$`NAB4 Clarifier Effluent E. coli (LAB) (EC/100mL)` + casdas$'NAB9 Clarifier Effluent E. coli (LAB) (EC/100mL)'))

casdas$'NAB4 and 9 Clarifier Effluent E. coli (LAB) (EC/100mL)'[casdas$'NAB4 and 9 Clarifier Effluent E. coli (LAB) (EC/100mL)' == 0] <- NA
casdas <- casdas %>% select(-'NAB4 Clarifier Effluent E. coli (LAB) (EC/100mL)', -'NAB9 Clarifier Effluent E. coli (LAB) (EC/100mL)')

#next

casdas$`NAB4 C-Pass TKNH (LAB) (mg/L)`[is.na(casdas$`NAB4 C-Pass TKNH (LAB) (mg/L)`)] <- 0
casdas$`NAB9 C-Pass TKNH (LAB) (mg/L)`[is.na(casdas$`NAB9 C-Pass TKNH (LAB) (mg/L)`)] <- 0

casdas <- mutate(casdas, "NAB4 and 9 C-Pass TKNH (LAB) (mg/L)" = 
              (casdas$`NAB4 C-Pass TKNH (LAB) (mg/L)` + casdas$`NAB9 C-Pass TKNH (LAB) (mg/L)`))

casdas$'NAB4 and 9 C-Pass TKNH (LAB) (mg/L)'[casdas$'NAB4 and 9 C-Pass TKNH (LAB) (mg/L)' == 0] <- NA
casdas <- casdas %>% select(-'NAB4 C-Pass TKNH (LAB) (mg/L)', -'NAB9 C-Pass TKNH (LAB) (mg/L)')

# next

casdas$`NAB4 C-Pass dSVI 30 (mL/g)`[is.na(casdas$`NAB4 C-Pass dSVI 30 (mL/g)`)] <- 0
casdas$`NAB9 C-Pass dSVI 30 (mL/g)`[is.na(casdas$`NAB9 C-Pass dSVI 30 (mL/g)`)] <- 0

casdas <- mutate(casdas, "NAB4 and 9 C-Pass dSVI 30 (mL/g)" = 
              (casdas$`NAB4 C-Pass dSVI 30 (mL/g)` + casdas$`NAB9 C-Pass dSVI 30 (mL/g)`))

casdas$'NAB4 and 9 C-Pass dSVI 30 (mL/g)'[casdas$'NAB4 and 9 C-Pass dSVI 30 (mL/g)' == 0] <- NA
casdas <- casdas %>% select(-'NAB4 C-Pass dSVI 30 (mL/g)', -'NAB9 C-Pass dSVI 30 (mL/g)')

#next

casdas$`NAB4 C-Pass dSVI 5 (mL/g)`[is.na(casdas$`NAB4 C-Pass dSVI 5 (mL/g)`)] <- 0
casdas$`NAB9 C-Pass dSVI 5 (mL/g)`[is.na(casdas$`NAB9 C-Pass dSVI 5 (mL/g)`)] <- 0

casdas <- mutate(casdas, "NAB4 and 9 C-Pass dSVI 5 (mL/g)" = 
              (casdas$`NAB4 C-Pass dSVI 5 (mL/g)` + casdas$`NAB9 C-Pass dSVI 5 (mL/g)`))

casdas$'NAB4 and 9 C-Pass dSVI 5 (mL/g)'[casdas$'NAB4 and 9 C-Pass dSVI 5 (mL/g)' == 0] <- NA
casdas <- casdas %>% select(-'NAB4 C-Pass dSVI 5 (mL/g)', -'NAB9 C-Pass dSVI 5 (mL/g)')




#pair up pilot with non-pilot variables
variable_pairs <- data.frame(
  "SLR" = c("Clarifier 2 SLR (ppd/sf)", "Clarifier 9 SLR (ppd/sf)"),
  "SOR" = c( "Clarifier 2 SOR (gpd/sf)", "Clarifier 9 SOR (gpd/sf)"),
  "Clarifier Effluent E. coli" = c("NAB2 Clarifier Effluent E. coli (LAB) (EC/100mL)",
                                   "NAB4 and 9 Clarifier Effluent E. coli (LAB) (EC/100mL)"),
  "C-Pass Total COD" = c("NAB2 C-Pass Total COD (LAB) (mg/L)", "NAB9 C-Pass Total COD (LAB) (mg/L)"),
  "C-Pass TKNH" = c("NAB2 C-Pass TKNH (LAB) (mg/L)", "NAB4 and 9 C-Pass TKNH (LAB) (mg/L)"),
  "C-Pass TSS" = c("NAB2 C-Pass TSS (LAB) (mg/L)", "NAB9 C-Pass TSS (LAB) (mg/L)"),
  "C-Pass VSS" = c("NAB2 C-Pass VSS (LAB) (mg/L)", "NAB9 C-Pass VSS (LAB) (mg/L)"),
  "A DO" = c("AB2A DO (mg/L)", "AB9A DO (mg/L)"),
  "B DO" = c("AB2B DO (mg/L)", "AB9B DO (mg/L)"),
  "C DO" = c("AB2C DO (mg/L)", "AB9C DO (mg/L)"),
  "A NO5" = c("AB2A NO5 (mgN/L)", "AB9A NO5 (mg N/L)"),
  "A NH3" = c("AB2A NH3 (mg N/L)", "AB9A NH3 (mg N/L)"),
  "C NH3" = c("AB2C NH3 (mg N/L)", "AB9C NH3 (mg N/L)"),
  "C MLSS" = c("AB2C MLSS (mg/L)", "AB9C MLSS (mg/L)"),
  "SAR PH" = c("SAR 2 PH (Std Units)", "SAR 4 PH (Std Units)"),
  "SAR ORP" = c("SAR 2 ORP (mV)", "SAR 4 ORP (mV)"),
  "SAR MLSS" = c("SAR 2 MLSS (mg/L)", "SAR 4 MLSS (mg/L)"),
  "AB INF FLOW" = c("AB2 INF FLOW (MGD)", "AB9 INF FLOW (MGD)"),
  "AB MLR FLOW" = c("AB2 MLR FLOW (MGD)", "AB9 MLR FLOW (MGD)"),
  "AB_A AIRFLOW" = c("AB2A AIRFLOW (SCFM)", "AB9A AIRFLOW (SCFM)"),
  "AB_B AIRFLOW" = c("AB2B AIRFLOW (SCFM)", "AB9B AIRFLOW (SCFM)"),
  "AB_C AIRFLOW" = c("AB2C AIRFLOW (SCFM)", "AB9C AIRFLOW (SCFM)"),
  "SAR RAS FLOW B" = c("SAR2 RAS FLOW B (MGD)", "SAR4 RAS FLOW B (MGD)"),
  "SAR GTE FLOW" = c("SAR2 GTE FLOW (gpm)", "SAR4 GTE FLOW (gpm)"),
  "SC BLANKET" = c("SC2 BLANKET (ft)", "SC9 BLANKET (ft)"),
  "NAB C-Pass dSVI 30" = c("NAB2 C-Pass dSVI 30 (mL/g)", "NAB4 and 9 C-Pass dSVI 30 (mL/g)"),
  "NAB C-Pass dSVI 5" = c("NAB2 C-Pass dSVI 5 (mL/g)", "NAB4 and 9 C-Pass dSVI 5 (mL/g)")
  )

# reorder casdas
namestring <- unlist(variable_pairs)
# Rearrange casdas by namestring
casdas <- casdas[, match(namestring, names(casdas))]

```

Conduct paired t tests
```{r}

# Perform t-tests for each pair of variables
results <- list()

for (i in 1:ncol(variable_pairs)) {
  var1 <- variable_pairs[1, i]
  var2 <- variable_pairs[2, i]
  
  x <- na.omit(casdas[, var1])
  y <- na.omit(casdas[, var2])
  
  result <- t.test(x, y, paired = FALSE)
  
  # Store the t-test result in the list
  results[[paste(var1, var2, sep = " vs. ")]] <- result
}


# Access t-test results for each pair
for (pair in names(results)) {
  print(paste("T-test for", pair))
  print(results[[pair]])
}


```

distributions for all paired variables
```{r}
# Create an empty list to store the plots
plots <- list()

# Loop through each variable pair
for (i in 1:ncol(variable_pairs)) {
  var1 <- variable_pairs[1, i]
  var2 <- variable_pairs[2, i]
  
  # Extract the data for each variable pair
  x <- casdas[[var1]]
  y <- casdas[[var2]]
  
  # Remove NA values from the data
  x_clean <- na.omit(x)
  y_clean <- na.omit(y)
  
  # Create a combined dataframe for plotting
  df <- data.frame(Value = c(x_clean, y_clean),
                   Group = c(rep(var1, length(x_clean)), rep(var2, length(y_clean))))
  
  # Create the paired distribution curve plot using ggplot2
  plot <- ggplot(df, aes(x = Value, fill = Group, color = Group)) +
    geom_density(alpha = 0.5) +
    labs(title = paste(var1, "vs.", var2),
         x = "Value",
         y = "Density") +
    scale_fill_manual(values = c("#D67C48", "#5DADE2")) +
    scale_color_manual(values = c("#D67C48", "#5DADE2"))
  
  # Store the plot in the list
  plots[[paste(var1, var2, sep = " vs. ")]] <- plot
}

# Display the plots
for (plot in plots) {
  print(plot)
}

```



boxplot all paired variables
```{r}
# Create an empty list to store the plots
plots <- list()

# Loop through each variable pair
for (i in 1:ncol(variable_pairs)) {
  var1 <- variable_pairs[1, i]
  var2 <- variable_pairs[2, i]
  
  # Extract the data for each variable pair
  x <- casdas[[var1]]
  y <- casdas[[var2]]
  
  # Remove NA values from the data
  x_clean <- na.omit(x)
  y_clean <- na.omit(y)
  
  # Create a combined dataframe for plotting
  df <- data.frame(Value = c(x_clean, y_clean),
                   Group = c(rep(var1, length(x_clean)), rep(var2, length(y_clean))))
  
  # Create the boxplot and distribution curve plot using ggplot2
  plot <- ggplot(df, aes(x = Group, y = Value)) +
    geom_boxplot(fill = c("#D67C48", "#5DADE2"), color = "black", outlier.color = "black") +
    geom_density(alpha = 0.5) +
    labs(title = paste(var1, "vs.", var2),
         x = "Group",
         y = "Value")
  
  # Store the plot in the list
  plots[[paste(var1, var2, sep = " vs. ")]] <- plot
}

# Display the plots
for (plot in plots) {
  print(plot)
}
```

#make a new dataframe of bootstrapped sample means
```{r}
# Set the number of bootstrap iterations
num_iterations <- 1000

# Create an empty dataframe to store the bootstrap means
casdas_boot <- data.frame(matrix(nrow = num_iterations, ncol = 54))
colnames(casdas_boot) <- colnames(casdas)

# Bootstrap each variable and calculate the means
for (col in colnames(casdas)) {
  bootstrap_means <- replicate(num_iterations, {
    # Remove NA values from the variable
    variable <- na.omit(casdas[[col]])
    
    # Generate bootstrap sample
    boot_sample <- sample(variable, size = 50, replace = TRUE)
    
    # Calculate the mean of the bootstrap sample
    mean(boot_sample)
  })
  
  casdas_boot[[col]] <- bootstrap_means
}
```


distributions for bootstrapped variables
```{r}
# Create an empty list to store the plots
plots <- list()

# Loop through each variable pair
for (i in 1:ncol(variable_pairs)) {
  var1 <- variable_pairs[1, i]
  var2 <- variable_pairs[2, i]
  
  # Extract the data for each variable pair
  x <- casdas_boot[[var1]]
  y <- casdas_boot[[var2]]
  
  # Remove NA values from the data
  x_clean <- na.omit(x)
  y_clean <- na.omit(y)
  
  # Create a combined dataframe for plotting
  df <- data.frame(Value = c(x_clean, y_clean),
                   Group = c(rep(var1, length(x_clean)), rep(var2, length(y_clean))))
  
  # Create the paired distribution curve plot using ggplot2
  plot <- ggplot(df, aes(x = Value, fill = Group, color = Group)) +
    geom_density(alpha = 0.5) +
    labs(title = paste(var1, "vs.", var2),
         x = "Value",
         y = "Density") +
    scale_fill_manual(values = c("#D67C48", "#5DADE2")) +
    scale_color_manual(values = c("#D67C48", "#5DADE2"))
  
  # Store the plot in the list
  plots[[paste(var1, var2, sep = " vs. ")]] <- plot
}

# Display the plots
for (plot in plots) {
  print(plot)
}

```


Calculate confidence intervals
```{r}
# Create an empty dataframe to store the confidence intervals
casdas_intervals <- data.frame(matrix(nrow = 2, ncol = 54))
colnames(casdas_intervals) <- colnames(casdas_boot)

# Calculate the confidence intervals for each variable
for (col in colnames(casdas_boot)) {
  variable <- casdas_boot[[col]]
  
  # Calculate the 5th and 95th percentiles
  ci <- quantile(variable, probs = c(0.05, 0.95))
  
  # Store the confidence interval in the dataframe
  casdas_intervals[1, col] <- ci[1]
  casdas_intervals[2, col] <- ci[2]
}
```

for the table
```{r}
# Create an empty vector to store the rounded interval values
interval_vector <- vector("character", length = ncol(casdas_intervals))

# Generate the interval vector
for (i in 1:ncol(casdas_intervals)) {
  lower_bound <- round(casdas_intervals[1, i], digits = 1)
  upper_bound <- round(casdas_intervals[2, i], digits = 1)
  interval_vector[i] <- paste0("(", lower_bound, ", ", upper_bound, ")")
}


# Create an empty dataframe with the appropriate number of rows
table_dataframe <- data.frame(matrix(nrow = 27, ncol = 2))

# Split the vector into two columns in the dataframe
table_dataframe[, 1] <- interval_vector[seq(1, 54, by = 2)]
table_dataframe[, 2] <- interval_vector[seq(2, 54, by = 2)]

view(table_dataframe)

# indax the names bc they got switched aroung
name_dataframe <- data.frame(matrix(nrow = 27, ncol = 2))
name_dataframe[, 1] <- colnames(casdas_intervals)[seq(1, 54, by = 2)]
name_dataframe[, 2] <- colnames(casdas_intervals)[seq(2, 54, by = 2)]


# Redo t-tests and put p-values in a dataframe 

# Perform t-tests for each pair of variables
results <- data.frame(Variable1 = character(), Variable2 = character(), P_value = numeric())

for (i in 1:ncol(variable_pairs)) {
  var1 <- variable_pairs[1, i]
  var2 <- variable_pairs[2, i]
  
  x <- na.omit(casdas[, var1])
  y <- na.omit(casdas[, var2])
  
  result <- t.test(x, y, paired = FALSE)
  
  # Extract p-value from t-test result
  p_value <- result$p.value
  
  # Add the result to the dataframe
  results <- rbind(results, data.frame(Variable1 = var1, Variable2 = var2, P_value = p_value))
}

# Print the dataframe with p-values
view(results$P_value)
b <- round(results$P_value, digits = 5)
view(b)

```


